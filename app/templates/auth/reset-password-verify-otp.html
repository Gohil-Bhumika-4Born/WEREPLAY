{% extends "base/auth_base.html" %}

{% set illustration_image = "Reset-Otp-Verify.png" %}

{% block title %}WeReplay Admin Panel - Reset Password OTP{% endblock %}
{% block meta_description %}Verify OTP to reset your WeReplay Admin Panel password.{% endblock %}
{% block meta_keywords %}WeReplay, Admin Panel, Reset Password, OTP Verification{% endblock %}

{% block illustration_title %}Check your email{% endblock %}
{% block illustration_description %}We have sent a 6-digit OTP to your email address. Enter the code below to continue resetting your password.{% endblock %}
{% block illustration_alt %}OTP Verification illustration{% endblock %}

{% block page_title %}Verify OTP{% endblock %}
{% block page_description %}Enter the 6-digit code we've sent to your email address{% endblock %}

{% block form_content %}
<!-- OTP Verification Form -->
<form id="resetOtpForm" method="POST" action="{{ url_for('auth.reset_password_verify_otp') }}" class="space-y-5 w-full max-w-2xl mx-auto">
    <!-- Email Text (no input) -->
    <div class="mb-0 text-center">
        <p class="text-xs text-gray mb-1">OTP has been sent to this email</p>
        <p class="inline-flex items-center gap-2 text-sm font-semibold text-dark">
            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span id="resetOtpEmailText" class="text-primaryDark break-all"></span>
        </p>
    </div>

    <!-- OTP Inputs -->
    <div class="mb-0">
        <label class="block text-sm text-gray-500 mb-3 text-center">Enter OTP Code</label>
        <div class="flex justify-center gap-3" id="resetOtpContainer">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl font-bold border border-gray rounded-lg text-gray focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300" autocomplete="off">
        </div>
        <input type="hidden" id="resetOtpValue" name="otp" value="">
    </div>

    <!-- Feedback Message -->
    <div id="resetOtpMessage" class="hidden text-center text-sm py-2 rounded-lg"></div>

    <!-- Verify OTP Button -->
    <div class="pt-3 flex justify-center">
        <button 
            type="submit" 
            id="resetVerifyOtpBtn"
            class="w-64 bg-primary hover:bg-primaryDark active:bg-primaryDark text-white font-semibold py-2.5 px-8 rounded-xl transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-[#18CB96]/30 active:translate-y-0 focus:outline-none focus:ring-4 focus:ring-[#18CB96]/50 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            aria-label="Verify reset OTP"
        >
            Verify OTP
        </button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const emailFromUrl = urlParams.get('email');
        const email = emailFromUrl || localStorage.getItem('resetEmail') || '';
        const emailText = document.getElementById('resetOtpEmailText');
        const otpInputs = document.querySelectorAll('#resetOtpContainer input');
        const otpHidden = document.getElementById('resetOtpValue');
        const form = document.getElementById('resetOtpForm');
        const btn = document.getElementById('resetVerifyOtpBtn');
        const msgEl = document.getElementById('resetOtpMessage');

        if (email && emailText) {
            emailText.textContent = email;
        }

        // OTP input behavior
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
                updateOtpValue();
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        function updateOtpValue() {
            const otp = Array.from(otpInputs).map(i => i.value).join('');
            otpHidden.value = otp;
        }

        if (form) {
            form.addEventListener('submit', function (e) {
                const otp = otpHidden.value.trim();

                // Validate OTP format
                if (otp.length !== 6) {
                    e.preventDefault();
                    showMessage('Please enter a valid 6-digit OTP.', 'error');
                    return false;
                }

                // Show loading state
                btn.disabled = true;
                btn.textContent = 'Verifying...';
                
                // Let the form submit normally to the backend
                // Backend will verify OTP and redirect with flash message
            });
        }

        function showMessage(text, type) {
            if (!msgEl) return;
            msgEl.textContent = text;
            msgEl.className = 'text-center text-sm py-2 rounded-lg ' + (type === 'error'
                ? 'bg-red-50 text-red-600 border border-red-200'
                : 'bg-green-50 text-green-600 border border-green-200');
            msgEl.classList.remove('hidden');

            setTimeout(function () {
                msgEl.classList.add('hidden');
            }, 5000);
        }

        // Focus first OTP box
        if (otpInputs.length > 0) {
            otpInputs[0].focus();
        }
    });
</script>
{% endblock %}
