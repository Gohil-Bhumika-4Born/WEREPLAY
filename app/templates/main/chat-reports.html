{% extends "base/main_base.html" %}

{% set current_page = 'chat_reports' %}

{% block title %}WeReplay Admin Panel - Chat Reports{% endblock %}

{% block page_title %}Chat Reports{% endblock %}

{% block page_icon %}
<svg class="w-6 h-6 text-primaryDark dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
{% endblock %}

{% block main_content %}
<!-- Chat Reports Content -->
            <div class="space-y-6 sm:space-y-8">
                <div class="space-y-6 sm:space-y-8">
                <!-- Page Title + Description -->
                <section
                    class="relative mt-3 sm:mt-4 lg:mt-5 overflow-hidden rounded-2xl sm:rounded-3xl bg-white/90 dark:bg-[#252525] border border-primary/15 dark:border-primary/20 shadow-lg shadow-primary/5 dark:shadow-black/30 px-4 sm:px-6 lg:px-8 py-4 sm:py-5 lg:py-6">
                    <div class="absolute inset-0 bg-gradient-to-r from-primary/10 via-transparent to-primaryDark/10 opacity-80 pointer-events-none"></div>
                    <div class="relative z-10 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <p class="text-[11px] sm:text-xs font-semibold tracking-[0.22em] uppercase text-primaryDark/80 mb-1 dark:text-white">
                                Analytics · Chat Topics
                            </p>
                            <h2 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900 dark:text-white leading-tight">
                                Conversation Overview
                            </h2>
                            <p class="mt-1 text-xs sm:text-sm text-gray-600 dark:text-gray-300 max-w-xl">
                                Track what your users are asking, how they feel, and where your AI needs improvement — all in one glance.
                            </p>
                        </div>
                        <!-- Quick Stats Pills -->
                        <div class="grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3 min-w-[220px] sm:min-w-[260px]">
                            <div
                                class="rounded-2xl bg-light/80 dark:bg-[#1E1E1E] border border-primary/20 px-3 py-2.5 sm:px-4 sm:py-3 flex flex-col justify-center">
                                <span class="text-[11px] sm:text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">
                                    Total Topics
                                </span>
                                <span id="totalTopicsCount"
                                      class="text-lg sm:text-xl font-extrabold text-primaryDark dark:text-white leading-snug">
                                    {{ stats.total }}
                                </span>
                            </div>
                            <div
                                class="rounded-2xl bg-primary/5 dark:bg-[#12352a] border border-primary/30 px-3 py-2.5 sm:px-4 sm:py-3 flex flex-col justify-center">
                                <span class="text-[11px] sm:text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wide">
                                    Positive % 
                                </span>
                                <span id="positivePercent"
                                      class="text-lg sm:text-xl font-extrabold text-primaryDark dark:text-primary leading-snug">
                                    {{ stats.positive_percent }}%
                                </span>
                            </div>
                            <div
                                class="rounded-2xl bg-red-50/90 dark:bg-red-900/20 border border-red-200/80 dark:border-red-700/60 px-3 py-2.5 sm:px-4 sm:py-3 flex flex-col justify-center">
                                <span class="text-[11px] sm:text-xs font-semibold text-red-700/90 dark:text-red-300 uppercase tracking-wide">
                                    Frustrated
                                </span>
                                <span id="frustratedCount"
                                      class="text-lg sm:text-xl font-extrabold text-red-600 dark:text-red-300 leading-snug">
                                    {{ stats.frustrated }}
                                </span>
                            </div>
                            <div
                                class="rounded-2xl bg-gray-50/90 dark:bg-[#1E1E1E] border border-gray-200/80 dark:border-gray-700 px-3 py-2.5 sm:px-4 sm:py-3 flex flex-col justify-center">
                                <span class="text-[11px] sm:text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wide">
                                    Avg. Messages
                                </span>
                                <span id="avgMessages"
                                      class="text-lg sm:text-xl font-extrabold text-gray-900 dark:text-white leading-snug">
                                    {{ stats.avg_messages }}
                                </span>
                            </div>
                        </div>
                    </div>
                </section>
                
                
                <section class="bg-white/95 dark:bg-[#252525] rounded-2xl sm:rounded-3xl shadow-lg shadow-primary/10 dark:shadow-black/40 overflow-hidden">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 p-4 sm:p-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Chat Topics</h3>
                        <div class="flex flex-row gap-3 items-center">
                            <!-- Search Input -->
                            <div class="relative lg:min-w-[300px]">
                                <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/>
                                    </svg>
                                </span>
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="Search topics..." 
                                    value="{{ filters.search or '' }}"
                                    onkeydown="if(event.key === 'Enter') applyFilters()"
                                    class="w-full pl-9 pr-3 py-2.5 bg-white/90 dark:bg-[#1E1E1E] border input-border-gray rounded-xl text-gray-900 dark:text-white text-sm placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-2 focus:ring-[#18CB96]">
                            </div>
                            <!-- Filter Button -->
                            <button onclick="openFilterModal()" class="inline-flex items-center justify-center px-3 py-2.5 bg-[#18CB96] hover:bg-primaryDark dark:bg-[#18CB96] dark:hover:bg-primaryDark text-white rounded-xl font-semibold transition-all duration-300 ease-out hover:scale-[1.02] text-sm shadow-md shadow-primary/30 hover:shadow-lg hover:shadow-[#18CB96]/30 flex-shrink-0">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                </svg>
                            </button>
                            <!-- Export Button -->
                            <button onclick="openExportModal()" class="px-4 py-2 bg-[#18CB96] hover:bg-primaryDark text-white rounded-lg font-medium transition-all duration-300 ease-out hover:scale-[1.02] text-sm flex items-center gap-2 shadow-md hover:shadow-lg">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl overflow-hidden">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-primaryDark dark:from-[#1E1E1E] dark:to-[#2A2A2A]">
                                    <th class="text-left py-3 px-3 sm:py-4 sm:px-6 text-xs sm:text-sm font-bold text-white dark:text-white uppercase tracking-wider rounded-tl-xl min-w-[200px]">Title & Description</th>
                                    <th class="text-left py-3 px-3 sm:py-4 sm:px-6 text-xs sm:text-sm font-bold text-white dark:text-white uppercase tracking-wider min-w-[100px]">Sentiment</th>
                                    <th class="text-left py-3 px-3 sm:py-4 sm:px-6 text-xs sm:text-sm font-bold text-white dark:text-white uppercase tracking-wider min-w-[120px]">Category</th>
                                    <th class="text-left py-3 px-3 sm:py-4 sm:px-6 text-xs sm:text-sm font-bold text-white dark:text-white uppercase tracking-wider min-w-[80px]">Messages</th>
                                    <th class="text-left py-3 px-3 sm:py-4 sm:px-6 text-xs sm:text-sm font-bold text-white dark:text-white uppercase tracking-wider rounded-tr-xl min-w-[100px]">Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="chatReportsTable">
                                {% if pagination.items %}
                                    {% for item in pagination.items %}
                                    {% set is_last_row = loop.last %}
                                    <tr class="{% if loop.index0 % 2 == 0 %}bg-primaryDark/5 dark:bg-[#2A2A2A]{% else %}bg-gray-50 dark:bg-[#1E1E1E]{% endif %} transition-all duration-300 ease-out cursor-pointer hover:bg-gray-100 dark:hover:bg-[#333333]" onclick="viewTopicDetails({{ item.id }})">
                                        <td class="py-3 px-3 sm:py-4 sm:px-6 {% if is_last_row %}rounded-bl-xl{% endif %}">
                                            <div>
                                                <p class="font-semibold text-gray-900 dark:text-white text-sm sm:text-base mb-1">{{ item.title }}</p>
                                                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">{{ item.description }}</p>
                                            </div>
                                        </td>
                                        <td class="py-3 px-3 sm:py-4 sm:px-6">
                                            <span class="px-2 py-0.5 sm:px-2.5 sm:py-1 text-xs font-medium rounded-full 
                                                {% if item.sentiment == 'POSITIVE' %}bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400
                                                {% elif item.sentiment == 'FRUSTRATED' %}bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400
                                                {% else %}bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400{% endif %}">
                                                {{ item.sentiment }}
                                            </span>
                                        </td>
                                        <td class="py-3 px-3 sm:py-4 sm:px-6">
                                            <span class="px-2 py-0.5 sm:px-2.5 sm:py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-full">{{ (item.category or 'N/A') | replace('_', ' ') | title }}</span>
                                        </td>
                                        <td class="py-3 px-3 sm:py-4 sm:px-6">
                                            <span class="text-xs sm:text-sm font-medium text-gray-900 dark:text-white">{{ item.message_count }}</span>
                                        </td>
                                        <td class="py-3 px-3 sm:py-4 sm:px-6 {% if is_last_row %}rounded-br-xl{% endif %}">
                                            <span class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">{{ item.last_check_time }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="p-12 text-center">
                                            <div class="flex flex-col items-center justify-center">
                                                <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                <p class="text-lg font-medium text-gray-900 dark:text-white mb-2">No chat topics found</p>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">Try adjusting your filters or search criteria</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State (Server Side handles this in the table body now) -->
                    <!-- <div id="emptyState" class="hidden p-12 text-center"> ... </div> -->
                </section>
                
                <!-- Server-Side Pagination -->
                {% if pagination.total > 0 %}
                <section class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-white/95 dark:bg-[#252525] rounded-2xl sm:rounded-3xl shadow-lg shadow-primary/5 dark:shadow-black/30 p-4 sm:p-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Showing <span id="showingFrom" class="font-medium text-gray-900 dark:text-white">{{ (pagination.page - 1) * pagination.per_page + 1 }}</span> to <span id="showingTo" class="font-medium text-gray-900 dark:text-white">{{ [(pagination.page * pagination.per_page), pagination.total]|min }}</span> of <span id="totalItems" class="font-medium text-gray-900 dark:text-white">{{ pagination.total }}</span> results
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="goToPage({{ pagination.prev_num }})" id="prevBtn" {% if not pagination.has_prev %}disabled{% endif %} class="px-4 py-2 bg-gray-100 dark:bg-[#333333] hover:bg-gray-200 dark:hover:bg-[#3A3A3A] text-gray-700 dark:text-gray-300 rounded-full font-medium transition-all duration-300 ease-out hover:scale-[1.02] text-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                            Previous
                        </button>
                        
                        <div class="flex items-center gap-1" id="pageNumbers">
                            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num == pagination.page %}
                                        <button class="px-3 py-2 rounded-lg font-medium text-sm bg-[#18CB96] text-white shadow-md cursor-default">
                                            {{ page_num }}
                                        </button>
                                    {% else %}
                                        <button onclick="goToPage({{ page_num }})" class="px-3 py-2 rounded-lg font-medium text-sm bg-gray-100 dark:bg-[#333333] text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#3A3A3A] transition-all duration-300 ease-out hover:scale-[1.05]">
                                            {{ page_num }}
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span class="px-2 text-gray-500 dark:text-gray-400">...</span>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <button onclick="goToPage({{ pagination.next_num }})" id="nextBtn" {% if not pagination.has_next %}disabled{% endif %} class="px-4 py-2 bg-gray-100 dark:bg-[#333333] hover:bg-gray-200 dark:hover:bg-[#3A3A3A] text-gray-700 dark:text-gray-300 rounded-full font-medium transition-all duration-300 ease-out hover:scale-[1.02] text-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                            Next
                        </button>
                        
                        <select id="rowsPerPage" onchange="changeRowsPerPage(this.value)" class="ml-4 px-3 py-2 bg-white dark:bg-[#1E1E1E] border input-border-gray dark:border-gray-600 rounded-lg text-gray-900 dark:text-white hover:border-gray-400 dark:hover:border-gray-500 focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none text-sm cursor-pointer">
                            <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10 per page</option>
                            <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20 per page</option>
                            <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                            <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100 per page</option>
                        </select>
                    </div>
                </section>
                {% endif %}
            </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="filter-modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop with Blur -->
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" aria-hidden="true" onclick="closeFilterModal()"></div>

        <div class="flex min-h-full items-center justify-center p-4">
            <div id="filterModalContent" class="relative bg-gradient-to-b from-white via-[#F6FFFB] to-[#ECFFF9] dark:from-[#1E1E1E] dark:via-[#1E1E1E] dark:to-[#1E1E1E] rounded-2xl shadow-2xl max-w-lg w-full p-6 transform transition-all duration-300 ease-out scale-95 opacity-0">
                <!-- Close Button -->
                <button onclick="closeFilterModal()" class="absolute top-4 right-4 rounded-lg text-gray-400 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#333333] transition-colors" aria-label="Close modal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- Modal Header -->
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-[#18CB96]/10 dark:bg-[#18CB96]/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#18CB96]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                    </div>
                    <h3 id="filter-modal-title" class="text-xl font-bold text-gray-900 dark:text-white">Filter Chat Reports</h3>
                </div>

                <!-- Filter Form -->
                <div class="space-y-6">
                    <!-- Sentiment Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Sentiment</label>
                        <select id="filter-sentiment" class="w-full px-3 py-2.5 bg-gray-50 dark:bg-[#252525] border input-border-gray dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none">
                            <option value="">All Sentiments</option>
                            <option value="positive" {% if filters.sentiment == 'positive' %}selected{% endif %}>Positive</option>
                            <option value="neutral" {% if filters.sentiment == 'neutral' %}selected{% endif %}>Neutral</option>
                            <option value="negative" {% if filters.sentiment == 'negative' %}selected{% endif %}>Negative</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Category</label>
                        <select id="filter-category" class="w-full px-3 py-2.5 bg-gray-50 dark:bg-[#252525] border input-border-gray dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none">
                            <option value="">All Categories</option>
                            <option value="training" {% if filters.category == 'training' %}selected{% endif %}>Training</option>
                            <option value="document" {% if filters.category == 'document' %}selected{% endif %}>Document</option>
                            <option value="whatsapp" {% if filters.category == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
                            <option value="billing" {% if filters.category == 'billing' %}selected{% endif %}>Billing</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Status</label>
                        <select id="filter-status" class="w-full px-3 py-2.5 bg-gray-50 dark:bg-[#252525] border input-border-gray dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none">
                            <option value="">All Status</option>
                            <option value="unread" {% if filters.status == 'unread' %}selected{% endif %}>Unread</option>
                            <option value="read" {% if filters.status == 'read' %}selected{% endif %}>Read</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">From Date</label>
                            <input type="date" id="filter-date-from" value="{{ filters.date_from or '' }}" class="w-full px-3 py-2.5 bg-gray-50 dark:bg-[#252525] border input-border-gray dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">To Date</label>
                            <input type="date" id="filter-date-to" value="{{ filters.date_to or '' }}" class="w-full px-3 py-2.5 bg-gray-50 dark:bg-[#252525] border input-border-gray dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:border-[#18CB96] dark:focus:border-[#18CB96] focus:outline-none">
                        </div>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="flex flex-col sm:flex-row gap-3 mt-8">
                    <button onclick="resetFilters()" class="flex-1 px-4 py-2.5 bg-primaryDark hover:bg-primaryDark/90 dark:bg-primaryDark dark:hover:bg-primaryDark/90 text-white rounded-lg font-medium transition-all duration-300 ease-out text-sm hover:scale-[1.02] hover:-translate-y-0.5 shadow-md hover:shadow-lg hover:shadow-primaryDark/30">
                        Reset Filters
                    </button>
                    <button onclick="applyFiltersFromModal()" class="flex-1 px-4 py-2.5 bg-[#18CB96] hover:bg-primaryDark/90 dark:bg-[#18CB96] dark:hover:bg-primaryDark/90 text-white rounded-lg font-medium transition-all duration-300 ease-out text-sm hover:scale-[1.02] hover:-translate-y-0.5 shadow-md hover:shadow-lg hover:shadow-[#18CB96]/30">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="export-modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop with Blur -->
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm pointer-events-none" aria-hidden="true"></div>

        <div class="flex min-h-full items-center justify-center p-4">
            <div id="exportModalContent" class="relative bg-gradient-to-b from-white via-[#F6FFFB] to-[#ECFFF9] dark:from-[#1E1E1E] dark:via-[#1E1E1E] dark:to-[#1E1E1E] rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all duration-300 ease-out scale-95 opacity-0 ring-[#18CB96]/20 dark:ring-[#18CB96]/30">
                <!-- Close Button -->
                <button onclick="closeExportModal()" class="absolute top-4 right-4 rounded-lg text-gray-400 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#333333] transition-colors" aria-label="Close modal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- Modal Header -->
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-[#18CB96]/10 dark:bg-[#18CB96]/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#18CB96]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 id="export-modal-title" class="text-xl font-bold text-gray-900 dark:text-white">Export Chat Reports</h3>
                </div>

                <!-- Export Options -->
                <div class="space-y-4 mb-8">
                    <!-- PDF Export -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#252525] rounded-xl border border-[#E0E0E0] hover:border-[#18CB96] transition-colors cursor-pointer" onclick="exportReport('pdf')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                <svg class="w-5 h-5 text-red-600 dark:text-red-400 " fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">PDF Document</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Export as PDF for printing or sharing</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>

                    <!-- Excel Export -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-[#252525] rounded-xl border border-[#E0E0E0] hover:border-[#18CB96] transition-colors cursor-pointer" onclick="exportReport('excel')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">Excel Spreadsheet</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Export as Excel for data analysis</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="flex justify-end">
                    <button onclick="closeExportModal()" class="px-4 py-2.5 bg-gray-100 dark:bg-[#333333] text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-200 dark:hover:bg-[#3A3A3A] transition-all duration-300 ease-out hover:scale-[1.02]">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Modal Control Functions
    function openFilterModal() {
        const modal = document.getElementById('filterModal');
        const content = document.getElementById('filterModalContent');
        modal.classList.remove('hidden');
        // Trigger animation
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeFilterModal() {
        const modal = document.getElementById('filterModal');
        const content = document.getElementById('filterModalContent');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function openExportModal() {
        const modal = document.getElementById('exportModal');
        const content = document.getElementById('exportModalContent');
        modal.classList.remove('hidden');
        // Trigger animation
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeExportModal() {
        const modal = document.getElementById('exportModal');
        const content = document.getElementById('exportModalContent');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function changeRowsPerPage(rows) {
        const params = new URLSearchParams(window.location.search);
        params.set('per_page', rows);
        params.set('page', 1); // Reset to page 1
        window.location.search = params.toString();
    }

    // URL Construction for Server-Side Filtering
    function buildFilterParams(pageOverride) {
        // Get values from modal inputs
        const sentiment = document.getElementById('filter-sentiment')?.value || '';
        const category = document.getElementById('filter-category')?.value || '';
        const status = document.getElementById('filter-status')?.value || '';
        const dateFrom = document.getElementById('filter-date-from')?.value || '';
        const dateTo = document.getElementById('filter-date-to')?.value || '';
        const search = document.getElementById('searchInput')?.value || '';
        const rowsPerPage = document.getElementById('rowsPerPage')?.value;
        
        let params = new URLSearchParams(window.location.search);
        
        // Update params with new values
        if (sentiment) params.set('sentiment', sentiment); else params.delete('sentiment');
        if (category) params.set('category', category); else params.delete('category');
        if (status) params.set('status', status); else params.delete('status');
        if (dateFrom) params.set('date_from', dateFrom); else params.delete('date_from');
        if (dateTo) params.set('date_to', dateTo); else params.delete('date_to');
        if (search) params.set('search', search); else params.delete('search');
        if (rowsPerPage) params.set('per_page', rowsPerPage);
        
        // Handle Page
        if (pageOverride) {
            params.set('page', pageOverride);
        } else {
            // Reset to page 1 on filter change
            params.set('page', 1); 
        }
        
        return params.toString();
    }
    
    function applyFiltersFromModal() {
        closeFilterModal();
        applyFilters();
    }
    
    function applyFilters() {
        const queryParams = buildFilterParams();
        window.location.href = "{{ url_for('main.chat_reports') }}?" + queryParams;
    }
    
    function goToPage(pageNum) {
        if (!pageNum) return;
        const queryParams = buildFilterParams(pageNum);
        window.location.href = "{{ url_for('main.chat_reports') }}?" + queryParams;
    }
    
    function resetFilters() {
        window.location.href = "{{ url_for('main.chat_reports') }}";
    }

    // View Topic Details
    function viewTopicDetails(topicId) {
        // Redirect to topic details page
        window.location.href = "{{ url_for('main.chat_reports_details') }}?topicId=" + topicId;
    }
    
    // Export Report
    function exportReport() {
        alert('Exporting report... This would download the report in selected format.');
    }
</script>
{% endblock %}
